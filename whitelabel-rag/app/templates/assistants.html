{% extends "base.html" %}
{% block title %}Assistants - WhiteLabelRAG{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Assistants</h2>
    <div class="accordion" id="assistantsAccordion">
        {% for assistant in assistants %}
        <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingA{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseA{{ loop.index }}" aria-expanded="false"
                    aria-controls="collapseA{{ loop.index }}">
                    <span class="badge bg-info me-2">{{ assistant.name }}</span>
                    <span class="text-muted small">({{ assistant.type }})</span>
                    <span class="ms-2 badge bg-{{ 'success' if assistant.status == 'online' else 'secondary' }}">{{ assistant.status|capitalize }}</span>
                </button>
            </h2>
            <div id="collapseA{{ loop.index }}" class="accordion-collapse collapse"
                aria-labelledby="headingA{{ loop.index }}" data-bs-parent="#assistantsAccordion">
                <div class="accordion-body">
                    <div>
                        <strong>Current Task:</strong>
                        <div>{{ assistant.current_task or "Idle" }}</div>
                    </div>
                    <div class="mt-2">
                        <strong>Mini Chat:</strong>
                        <form class="mini-chat-form" data-assistant="{{ assistant.id }}">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control mini-chat-input" placeholder="Ask {{ assistant.name }}..." autocomplete="off">
                                <button class="btn btn-primary" type="submit">Send</button>
                            </div>
                        </form>
                        <div class="mini-chat-history border rounded p-2 bg-light" style="min-height:60px;max-height:150px;overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">No assistants found.</div>
        {% endfor %}
    </div>
</div>
<script>
document.querySelectorAll('.mini-chat-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = form.querySelector('.mini-chat-input');
        const history = form.parentElement.querySelector('.mini-chat-history');
        const msg = input.value.trim();
        if (!msg) return;
        history.innerHTML += `<div><b>You:</b> ${msg}</div>`;
        input.value = '';
        // Example: AJAX call to backend for assistant chat (implement endpoint as needed)
        fetch('/assistants/chat/' + form.dataset.assistant, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: msg})
        })
        .then(r => r.json())
        .then(data => {
            history.innerHTML += `<div><b>{{ assistant.name }}:</b> ${data.reply || '[No reply]'}</div>`;
            history.scrollTop = history.scrollHeight;
        });
    });
});
</script>
{% endblock %}
